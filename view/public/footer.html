<?php if ($Quicklogin != 'no'): ?>
<div class="divider my-4">
  <div class="divider-text">or</div>
</div>
<div class="d-flex justify-content-center">
  <?php foreach ($Quicklogin as $key => $value): if($value['isOpen'] == 'yes'):?>
  <a href="{$value['url']}" class="btn btn-icon me-3 {$value['class']}">
    <i class="fa-brands {$value['icon']}"></i>
  </a>
  <?php endif; endforeach; ?>
</div>
<?php endif; ?>
</div>
</div>
</div>
</div>
<footer class="footer footer-bar" style="margin-top:-3%;">
  <div class="container text-center">
    <div class="row align-items-center">
      <div>
        <div class="text-sm-left">
          <p class="mb-0">Copyright ©
            <script>
              document.write(new Date().getFullYear());
            </script> <a href="/">{:getConfig()['sitename']}</a> - All
            rights reserved<span class="sep"> | </span><a href="https://beian.miit.gov.cn" target="_blank"
              rel="noreferrer nofollow">{:getConfig()['icp']}</a>
          </p>
        </div>
      </div>
    </div>
  </div>
</footer>
</div>

<input id='functions' value="[functons]" type="text" hidden>
<!-- Core JS -->

<!-- Vendors JS -->
<script src="/user/default/static/assets/vendor/libs/formvalidation/dist/js/FormValidation.min.js"></script>
<script src="/user/default/static/assets/vendor/libs/formvalidation/dist/js/FormValidation.full.min.js"></script>
<script src="/user/default/static/assets/vendor/libs/formvalidation/dist/js/plugins/Bootstrap5.min.js"></script>
<script src="/user/default/static/assets/vendor/libs/formvalidation/dist/js/plugins/AutoFocus.min.js"></script>
<!-- Other JS -->
<script src="/user/default/static/assets/vendor/libs/cleavejs/cleave.js"></script>
<script src="/user/default/static/assets/vendor/libs/cleavejs/cleave-phone.js"></script>

<!-- Main JS -->
<script src="/user/default/static/assets/js/main.js"></script>
<script src="/static/component/layui/layui.js"></script>
<script src="/static/component/pear/pear.js"></script>
<!-- Page JS -->
<script>
  layui.use(['form', 'formX'], function () {
    var $ = layui.jquery;
    var form = layui.form;
    var formX = layui.formX;

    //验证输入的验证码是否为数字
    const numeralMask = document.querySelector('#numeral-mask')
    //Numeral
    if (numeralMask) {
      new Cleave(numeralMask, {
        numeral: true,
        numeralThousandsGroupStyle: 'false'
      });
    }
    const formAuthentication = document.querySelector('#formAuthentication');
    if (formAuthentication) {
      const fv = FormValidation.formValidation(formAuthentication, {
        fields: {
          'username': {
            validators: {
              notEmpty: {
                message: '请 输 入 您 的 账 号'
              }
            }
          },
          'password': {
            validators: {
              notEmpty: {
                message: '请 输 入 您 的 密 码'
              },
              stringLength: {
                min: 6,
                message: '密 码 最 少 需 要 6 位'
              }
            }
          },
          'password2': {
            validators: {
              notEmpty: {
                message: '请 再 次 输 入 您 的 密 码'
              },
              identical: {
                compare: function () {
                  return formAuthentication.querySelector('[name="password"]').value;
                },
                message: '两 次 密 码 输 入 不 相 同, 请 检 查'
              },
              stringLength: {
                min: 6,
                message: '密 码 最 少 需 要 6 位'
              }
            }
          },
          'mobile': {
            validators: {
              notEmpty: {
                message: '请 输 入 您 的 手 机 号'
              },
              phone: {
                country: 'CN',
                message: '请 输 入 正 确 的 手 机 号',
              },
            }
          },
          'email': {
            validators: {
              notEmpty: {
                message: '请 输 入 您 的 邮 箱'
              },
              emailAddress: {
                message: '请 输 入 正 确 的 邮 箱 地 址',
              },
            }
          },
          'captcha': {
            validators: {
              notEmpty: {
                message: '请 输 入 您 的  验 证 码'
              }
            }
          },
          'ordinary_captcha': {
            validators: {
              notEmpty: {
                message: '请 输 入 验 证 码'
              }
            }
          },
          'terms': {
            validators: {
              notEmpty: {
                message: '请 同 意 协 议'
              }
            }
          },
        },
        plugins: {
          trigger: new FormValidation.plugins.Trigger(),
          bootstrap5: new FormValidation.plugins.Bootstrap5({
            eleValidClass: '',
            rowSelector: '.mb-3'
          }),
          submitButton: new FormValidation.plugins.SubmitButton(),

          //   defaultSubmit: new FormValidation.plugins.DefaultSubmit(),
          autoFocus: new FormValidation.plugins.AutoFocus()
        },
        init: instance => {
          instance.on('plugins.message.placed', function (e) {
            if (e.element.parentElement.classList.contains('input-group')) {
              e.element.parentElement.insertAdjacentElement('afterend', e.messageElement);
            }
          });
        }
      });

      // 提取常量
      const URLS = {
        LOGIN: '/User/Login',
        NOTICE: '/User/notice',
        INDEX: '/User/Index',
        LOGIN_PAGE: '/User/Login'
      };

      // 通用消息配置
      const MSG_CONFIG = {
        SUCCESS: { icon: 1, time: 1500 },
        ERROR: { icon: 2, anim: 6 }
      };

      // 通用处理函数
      const handleNotice = (type, data) => {
        $.post(URLS.NOTICE, { type, data }, () => { }, 'json');
      };

      const handleRedirect = (url) => {
        location.replace(url);
      };

      const showMessage = (msg, config, callback) => {
        layer.msg(msg, config, callback);
      };

      const handleLoginSuccess = () => {
        showMessage('登录成功', MSG_CONFIG.SUCCESS, () => {
          handleNotice('login');
          handleRedirect(URLS.INDEX);
        });
      };

      const handleRegisterSuccess = (data) => {
        showMessage('注册成功', MSG_CONFIG.SUCCESS, () => {
          handleNotice('register', data);
          handleRedirect(URLS.LOGIN_PAGE);
        });
      };

      const handleError = (msg, refreshCaptcha) => {
        showMessage(msg, MSG_CONFIG.ERROR);
        refreshCaptcha();
      };

      // 登录/注册主逻辑
      fv.on('core.form.valid', function () {
        const functions = $("#functions").val();
        const formData = $('#formAuthentication').serializeArray();

        const handleRequest = (url, data, successHandler) => {
          $.post(url, $.param(data), function (res) {
            if (res.code === 200) {
              successHandler();
            } else if (res.code === 202) {
              handleSecurityCode(data);
            } else if (res.code === 888) {
              showPaymentPage(res);
            } else {
              handleError(res.msg, f5Captcha);
            }
          }, 'json').fail(() => {
            handleError('请求失败，请检查网络', f5Captcha);
          });
        };

        const handleSecurityCode = (baseData) => {
          layer.prompt({
            title: '请输入安全效验码',
            formType: 1
          }, (googlekey, index) => {
            const newData = [...baseData,
            { name: 'google', value: 'yes' },
            { name: 'securityCode', value: googlekey }
            ];

            handleRequest(URLS.LOGIN, newData, handleLoginSuccess);
            layer.close(index);
          });
        };

        function showPaymentPage(res) {
  // 防御性数据校验
  if (!res || !res.paytype || !res.trade_no) {
    console.error('无效的支付数据:', res);
    return;
  }

  // 使用模板字符串提升可读性
  let payContent = `
    <center>
      <h2>￥ ${res.need || '0.00'}</h2>
      <hr>
      <div class="payment-buttons">
  `;

  // 安全遍历支付方式
  res.paytype.forEach((payment) => {
    // 过滤非法字符防止XSS
    const safeName = payment.name.replace(/[^a-z0-9]/gi, '');
    const safeShowname = $('<div>').text(payment.showname).html();

    payContent += `
      <button class="btn btn-default btn-block payment-btn" 
              data-type="${safeName}" 
              data-trade="${res.trade_no}">
        <img width="20" 
             src="/static/index/images/icon/${safeName}.ico" 
             class="logo"
             onerror="this.remove()">
        ${safeShowname}
      </button>
    `;
  });

  payContent += `
      <center>
      <hr>
      <div class="text-muted">提示：支付完成后即可直接登录</div>
    </center>
  `;

  // 使用事件委托绑定点击
  const layerId = layer.alert(payContent, {
    btn: [],
    title: '支付确认页面',
    closeBtn: false,
    success: function(layerElem) {
      $(layerElem).on('click', '.payment-btn', function() {
        const type = $(this).data('type');
        const tradeNo = $(this).data('trade');
        window.location.href = `../Pay/Reg?typeid=${type}&trade_no=${tradeNo}`;
      });
    }
  });

  // 添加关闭回调
  layer.style(layerId);
}
        if (functions === "login") {
          handleRequest(URLS.LOGIN, formData, handleLoginSuccess);
        } else {
          handleRequest(`/User/${functions}`, formData, () => {
            handleRegisterSuccess(formData);
          });
        }

        return false;
      });


      form.on('submit(qq_captcha_callback)', function () {

        // 定义回调函数
        function callback(res) {
          // 第一个参数传入回调结果，结果如下：
          // ret         Int       验证结果，0：验证成功。2：用户主动关闭验证码。
          // ticket      String    验证成功的票据，当且仅当 ret = 0 时 ticket 有值。
          // CaptchaAppId       String    验证码应用ID。
          // bizState    Any       自定义透传参数。
          // randstr     String    本次验证的随机串，后续票据校验时需传递该参数。
          // res（用户主动关闭验证码）= {ret: 2, ticket: null}
          // res（验证成功） = {ret: 0, ticket: "String", randstr: "String"}
          // res（请求验证码发生错误，验证码自动返回terror_前缀的容灾票据） = {ret: 0, ticket: "String", randstr: "String",  errorCode: Number,     errorMessage: "String"}
          // 此处代码仅为验证结果的展示示例，真实业务接入，建议基于ticket和errorCode情况做不同的业务处理
          if (res.ret === 0) {
            $.post('/User/Captcha', res, function (res) {
              if (res.code == 200) {
                $('#tencentCaptcha').html('<button type="button" class="TencentCaptcha btn  w-100 mb-3" id="TencentCaptcha" data-appid ="{:$config['tencent_CaptchaAppId']}" data-cbfn="qq_aptcha_callback" disabled="disabled" style="background-color: rgb(139,  195, 74); color: rgb(255, 255, 255);"><i class="fa-solid fa-circle-check"></i> &nbsp;验证通过</button>');
              }
            }, 'json');
            return false;
            // // 复制结果至剪切板
            // var str = '【randstr】->【' + res.randstr + '】      【ticket】->【' + res.ticket + '】';
            // var ipt = document.createElement('input');
            // ipt.value = str;
            // document.body.appendChild(ipt);
            // ipt.select();
            // document.execCommand("Copy");
            // document.body.removeChild(ipt);
          }
        }

        // 定义验证码js加载错误处理函数
        function loadErrorCallback() {
          var appid = ''
          // 生成容灾票据或自行做其它处理
          var ticket = 'terror_1001_' + appid + Math.floor(new Date().getTime() / 1000);
          callback({
            ret: 0,
            randstr: '@' + Math.random().toString(36).substr(2),
            ticket,
            errorCode: 1001,
            errorMessage: 'jsload_error',
          });
        }

        try {
          // 生成一个验证码对象
          // CaptchaAppId：登录验证码控制台，从【验证管理】页面进行查看。如果未创建过验证，请先新建验证。注意：不可使用客户端类型为小程序的CaptchaAppId，会导致数据统计错误。
          //callback：定义的回调函数
          var captcha = new TencentCaptcha('{:$config['tencent_CaptchaAppId']}', callback, {});
          // 调用方法，显示验证码
          captcha.show();
        } catch (error) {
          // 加载异常，调用验证码js加载错误处理函数
          loadErrorCallback();
        }
      });

      {if condition = "$config['captcha-type'] == '3'"}
      //极验行为验证
      initGeetest4({
        captchaId: '{:$config['geetest_CaptchaAppId']}',
      }, function (captcha) {
        // captcha为验证码实例
        captcha.appendTo("#geetest_captcha");// 调用appendTo将验证码插入到页的某一个元素中，这个元素用户可以自定义
        captcha.onSuccess(function () {
          var result = captcha.getValidate();
          $.post('/User/Captcha', result, function (res) {
            console.log(res);
          }).onError(function () {
            //your code
          });
        });
      });
      {/if}

        // 获取验证码
        $('#send-code').click(function (data) {
          var email = $("#email").val();
          var mobile = $("#mobile").val();
          // 获取对应方法名称				    
          var functions = $("#functions").val();
          //点击一次之后禁止继续点击
          $('#send-code').attr('disabled', "true");
          var path = '';
          if (functions == "login") {
            path = 'getLoginCode';
          } else {
            path = 'getRegCode';
          }

          $.post('/User/' + path, {
            email: email,
            mobile: mobile
          }, function (res) {
            if (res.code === 200) {
              setTimeout(function () {
                formX.startTimer('#send-code', 60, function (t) {
                  return '已发送(' + t + 's)';
                });
              }, 600);
              //倒计时结束之后恢复点击
              $('#send-code').removeAttr("disabled");
              return false;
            } else {
              layer.msg(res.msg, {
                icon: 2,
                anim: 6
              });
              //返回信息之后恢复点击
              $('#send-code').removeAttr("disabled");
              f5Captcha();
            }
          }, 'json');
          return false;
        });

        /* 图形验证码 */
        var captchaUrl = '/User/Verify';
        $('img.login-captcha').click(function () {
          f5Captcha();
        }).trigger('click');

        function f5Captcha() {
          var img = captchaUrl + '?t=' + (new Date).getTime();
          $('img.login-captcha').attr('src', img);
        }

      }
    });
</script>
{if condition="($config['reg_popup'] != null || $config['reg_popup'] != '') && $pop =='yes'"}
<div class="web_notice"
  style="position: fixed;top: 0;left: 0;width: 100%;height: 100%;background: rgba(0,0,0,0.3);z-index: 99999;">
  <div
    style="position: fixed;top: 50%;left: 50%;width: 350px;background: #FFF;transform: translate(-50%, -50%);border-radius: 40px;padding: 50px 40px;">
    <h3 style="font-weight: bold;text-align: center;font-size: 30px;">注册须知</h3>
    <div style="font-size: 16px;margin-top: 26px;line-height: 30px;color: #999;"><br />
      <font color="purple">{:$config['reg_popup']}
    </div>
    <a style="display: block;background: #98a3ff;color: #FFF;text-align: center;font-weight: bold;font-size: 19px;line-height: 60px;margin: 0 auto;margin-top: 45px;border-radius: 32px;width: 80%;"
      onclick="javascript:document.querySelector('.web_notice').remove()">好的</a>
  </div>
</div>
{/if}
</body>

</html>